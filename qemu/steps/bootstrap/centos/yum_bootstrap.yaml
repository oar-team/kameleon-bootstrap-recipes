- fix_yum:
  - check_cmd_out: yum
  - exec_out: sed -i "s/opts.ssl_verify_host/2/g" /usr/lib/pymodules/python2.7/urlgrabber/grabber.py

- init_rpm_db:
  - check_cmd_out: rpm
  - exec_out: mkdir -p $$rootfs/var/lib/rpm
  - exec_out: rpm --root $$rootfs --initdb

- fetch_and_install_release_packages:
  - check_cmd_out: lynx
  - check_cmd_out: curl
  - exec_out: |
      for package_name in `echo "$$release_packages" | tr ' ' '\n'`
      do
          rm -f $KAMELEON_WORKDIR/package.rpm
          package_url="$(lynx $$mirror_packages_url -dump -listonly -nonumbers | grep $package_name | head -1)"
          curl -# -L --retry 999 --retry-max-time 0 $package_url -o $KAMELEON_WORKDIR/package.rpm 2>&1 || fail "$package_name package not found!"
          rpm --root $$rootfs -ivh --force-debian --nodeps $KAMELEON_WORKDIR/package.rpm
      done

- install_yum:
  - exec_out: ln -sf $$rootfs/etc/pki/ /etc/pki
  - exec_out: yum --releasever=$$release --installroot $$rootfs -y repolist all
  - exec_out: yum --releasever=$$release --installroot $$rootfs -y install yum yum-utils
  - exec_out: echo $${release} > $$rootfs/etc/yum/vars/releasever

- mount_chroot:
  - exec_out: mount -o bind /dev  $$rootfs/dev
  - exec_out: mount -o bind /dev/pts $$rootfs/dev/pts
  - exec_out: mount -t proc /proc  $$rootfs/proc
  - exec_out: mount -t sysfs /sys  $$rootfs/sys
  - exec_out: cp /etc/resolv.conf $$rootfs/etc/resolv.conf

- install_packages:
  - exec_out: chroot $$rootfs yum --releasever=$$release -y install $$include_pkgs

- enable_services:
  - exec_out: chroot $$rootfs chkconfig network on
  - exec_out: chroot $$rootfs chkconfig sshd on

- set_interface:
  - write_out:
    - $$rootfs/etc/sysconfig/network-scripts/ifcfg-eth0
    - |
      DEVICE=eth0
      BOOTPROTO=dhcp
      ONBOOT=yes
      HOSTNAME=$$hostname
      NM_CONTROLLED=no
      TYPE=Ethernet
  - write_out:
    - $$rootfs/etc/sysconfig/network
    - |
      NETWORKING=yes
      HOSTNAME=$$hostname

- umount_chroot:
  - on_clean:
    - umount_out: $$rootfs/sys
    - umount_out: $$rootfs/proc
    - umount_out: $$rootfs/dev/pts
    - umount_out: $$rootfs/dev
